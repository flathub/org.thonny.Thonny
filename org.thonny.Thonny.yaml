id: org.thonny.Thonny
runtime: org.freedesktop.Sdk
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: thonny
cleanup:
  - /man
  - /share/man
finish-args:
  # Thonny requires access to serial / USB devices for embedded development.
  - --device=all

  - --share=ipc
  - --share=network
  - --socket=x11
modules:
  # The `tkinter` module is missing from the Freedesktop Sdk's Python installation.
  - name: tkinter
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} .
    sources:
      - type: git
        url: https://github.com/iwalton3/tkinter-standalone
        commit: ba946536054f9d27a08aafde21aa18330ce05729
    modules:
      - name: tcl
        buildsystem: autotools
        subdir: unix
        post-install:
          - chmod 755 /app/lib/libtcl*.so
        cleanup:
          - /bin
          - /lib/pkgconfig
          - /man
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tcl8.6.12-src.tar.gz
            sha256: 26c995dd0f167e48b11961d891ee555f680c175f7173ff8cb829f4ebcde4c1a6
            x-checker-data:
              type: anitya
              project-id: 4941
              stable-only: true
              url-template: https://prdownloads.sourceforge.net/tcl/tcl$version-src.tar.gz
      - name: tk
        buildsystem: autotools
        subdir: unix
        post-install:
          - chmod 755 /app/lib/libtk*.so
        cleanup:
          - /bin
          - /lib/pkgconfig
          - /man
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tk8.6.12-src.tar.gz
            sha256: 12395c1f3fcb6bed2938689f797ea3cdf41ed5cb6c4766eec8ac949560310630
            x-checker-data:
              type: anitya
              project-id: 11426
              stable-only: true
              url-template: https://prdownloads.sourceforge.net/tcl/tk$version-src.tar.gz

  # Python dependencies required to build things
  - name: python3-toml
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "toml" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz
        sha256: b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f
        x-checker-data:
          type: pypi
          name: toml
  - name: python3-flit_core
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "flit_core" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/10/e5/be08751d07b30889af130cec20955c987a74380a10058e6e8856e4010afc/flit_core-3.8.0.tar.gz
        sha256: b305b30c99526df5e63d6022dd2310a0a941a187bd3884f4c8ef0418df6c39f3
        x-checker-data:
          type: pypi
          name: flit_core
  - name: python3-poetry-core
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "poetry-core" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/0d/07/2a30643e4177c8edafa037c8ee3c62e4390950ab01d5ebc86e04379e2ba7/poetry-core-1.3.2.tar.gz
        sha256: 0ab006a40cb38d6a38b97264f6835da2f08a96912f2728ce668e9ac6a34f686f
        x-checker-data:
          type: pypi
          name: poetry-core
  - name: python3-setuptools_scm
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "setuptools_scm" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/6c/10/a7d0fa5baea8fe7b50f448ab742f26f52b80bfca85ac2be9d35cdd9a3246/pyparsing-3.0.9-py3-none-any.whl
        sha256: 5026bae9a10eeaefb61dab2f09052b9f4307d44aee4eda64b309723d8d206bbc
        x-checker-data:
          name: pyparsing
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/0b/8e/f1a0a5a76cfef77e1eb6004cb49e5f8d72634da638420b9ea492ce8305e8/typing_extensions-4.4.0-py3-none-any.whl
        sha256: 16fa4864408f655d35ec496218b85f79b3437c829e93320c7c9215ccfd92489e
        x-checker-data:
          name: typing_extensions
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/97/75/10a9ebee3fd790d20926a90a2547f0bf78f371b2f13aa822c759680ca7b9/tomli-2.0.1-py3-none-any.whl
        sha256: 939de3e7a6161af0c887ef91b7d41a53e7c5a1ca976325f429cb46ea9bc30ecc
        x-checker-data:
          name: tomli
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/05/8e/8de486cbd03baba4deef4142bd643a3e7bbe954a784dc1bb17142572d127/packaging-21.3-py3-none-any.whl
        sha256: ef103e05f519cdc783ae24ea4e2e0f508a9c99b2d4969652eed6a2e1ea5bd522
        x-checker-data:
          name: packaging
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/01/ed/75a20e7b075e8ecb1f84e8debf833917905d8790b78008915bd68dddd5c4/setuptools_scm-7.0.5-py3-none-any.whl
        sha256: 7930f720905e03ccd1e1d821db521bff7ec2ac9cf0ceb6552dd73d24a45d3b02
        x-checker-data:
          name: setuptools_scm
          packagetype: bdist_wheel
          type: pypi
  - name: python3-typing_extensions
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "typing_extensions" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/0b/8e/f1a0a5a76cfef77e1eb6004cb49e5f8d72634da638420b9ea492ce8305e8/typing_extensions-4.4.0-py3-none-any.whl
        sha256: 16fa4864408f655d35ec496218b85f79b3437c829e93320c7c9215ccfd92489e
        x-checker-data:
          type: pypi
          name: typing_extensions
          packagetype: bdist_wheel
  - name: python3-setuptools_rust
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "setuptools_rust" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/7d/31/f2289ce78b9b473d582568c234e104d2a342fd658cc288a7553d83bb8595/semantic_version-2.10.0.tar.gz
        sha256: bdabb6d336998cbb378d4b9db3a4b56a1e3235701dc05ea2690d9a997ed5041c
        x-checker-data:
          type: pypi
          name: semantic_version
      - type: file
        url: https://files.pythonhosted.org/packages/99/db/e4ecb483ffa194d632ed44bda32cb740e564789fed7e56c2be8e2a0e2aa6/setuptools-rust-1.5.2.tar.gz
        sha256: d8daccb14dc0eae1b6b6eb3ecef79675bd37b4065369f79c35393dd5c55652c7
        x-checker-data:
          type: pypi
          name: setuptools-rust

  # The cryptography Python library is handled specially since it has Rust code and dependencies.
  - name: python3-cryptography
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/python3-cryptography/cargo
        CARGO_NET_OFFLINE: 'true'
        RUST_BACKTRACE: '1'
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "cryptography" --no-build-isolation --no-binary cryptography
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/5e/0b/95d387f5f4433cb0f53ff7ad859bd2c6051051cebbb564f139a999ab46de/pycparser-2.21.tar.gz
        sha256: e644fdec12f7872f86c58ff790da456218b10f863970249516d60a5eaca77206
        x-checker-data:
          type: pypi
          name: pycparser
      - type: file
        url: https://files.pythonhosted.org/packages/2b/a8/050ab4f0c3d4c1b8aaa805f70e26e84d0e27004907c5b8ecc1d31815f92a/cffi-1.15.1.tar.gz
        sha256: d400bfb9a37b1351253cb402671cea7e89bdecc294e8016a707f6d1d8ac934f9
        x-checker-data:
          type: pypi
          name: cffi
      - type: file
        url: https://files.pythonhosted.org/packages/13/dd/a9608b7aebe5d2dc0c98a4b2090a6b815628efa46cc1c046b89d8cd25f4c/cryptography-38.0.3.tar.gz
        sha256: bfbe6ee19615b07a98b1d2287d6a6073f734735b49ee45b11324d85efc4d5cbd
        x-checker-data:
          type: pypi
          name: cryptography
      # The Cargo sources should be updated whenever cryptography is updated.
      - cryptography-cargo-sources.json

  # The bcrypt Python library is handled specially since it has Rust code and dependencies.
  # The cryptography Python library is handled specially since it has Rust code and dependencies.
  - name: python3-bcrypt
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/python3-bcrypt/cargo
        CARGO_NET_OFFLINE: 'true'
        RUST_BACKTRACE: '1'
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "bcrypt" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/8c/ae/3af7d006aacf513975fd1948a6b4d6f8b4a307f8a244e1a3d3774b297aad/bcrypt-4.0.1.tar.gz
        sha256: 27d375903ac8261cfe4047f6709d16f7d18d39b1ec92aaf72af989552a650ebd
        x-checker-data:
          name: bcrypt
          type: pypi
      # The Cargo sources should be updated whenever bcrypt is updated.
      - bcrypt-cargo-sources.json

  # As of Python 3.10, the native C code compiled as part of the reedsolo package no longer builds.
  # Disable building the native code to avoid a build failure.
  - name: python3-reedsolo
    buildsystem: simple
    build-commands:
      - pip3 install --install-option="--nocython" --verbose --exists-action=i --no-index
        --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "reedsolo" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c8/cb/bb2ddbd00c9b4215dd57a2abf7042b0ae222b44522c5eb664a8fd9d786da/reedsolo-1.5.4.tar.gz
        sha256: b8b25cdc83478ccb06361a0e8fadc27b376a3dfabbb1dc6bb583a998a22c0127
        x-checker-data:
          name: reedsolo
          type: pypi

  # Python dependencies
  - bundled-python-modules.json

  - name: thonny
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/
      - install -Dm644 packaging/linux/org.thonny.Thonny.desktop -t ${FLATPAK_DEST}/share/applications
      - sed -i 's/Icon=thonny/Icon=org.thonny.Thonny/' ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - sed -i 's|Exec=/usr/bin/thonny|Exec=thonny|g' ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - for size in 16x16 22x22 32x32 48x48 64x64 128x128 192x192 256x256; do install
        -Dm644 -T packaging/icons/thonny-$size.png ${FLATPAK_DEST}/share/icons/hicolor/$size/apps/${FLATPAK_ID}.png;
        done
      - install -Dm644 packaging/linux/org.thonny.Thonny.appdata.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml
    sources:
      - thonny-sources.yaml
