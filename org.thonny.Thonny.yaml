id: org.thonny.Thonny
runtime: org.freedesktop.Sdk
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: thonny
cleanup:
  - /man
  - /share/man
finish-args:
  # Thonny requires access to serial / USB devices for embedded development.
  - --device=all

  - --share=ipc
  - --share=network
  - --socket=x11
modules:
  # The `tkinter` module is missing from the Freedesktop Sdk's Python installation.
  - name: tkinter
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} .
    sources:
      - type: git
        url: https://github.com/iwalton3/tkinter-standalone
        commit: ba946536054f9d27a08aafde21aa18330ce05729
    modules:
      - name: tcl
        buildsystem: autotools
        subdir: unix
        post-install:
          - chmod 755 /app/lib/libtcl*.so
        cleanup:
          - /bin
          - /lib/pkgconfig
          - /man
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tcl8.6.12-src.tar.gz
            sha256: 26c995dd0f167e48b11961d891ee555f680c175f7173ff8cb829f4ebcde4c1a6
            x-checker-data:
              type: anitya
              project-id: 4941
              stable-only: true
              url-template: https://prdownloads.sourceforge.net/tcl/tcl$version-src.tar.gz
      - name: tk
        buildsystem: autotools
        subdir: unix
        post-install:
          - chmod 755 /app/lib/libtk*.so
        cleanup:
          - /bin
          - /lib/pkgconfig
          - /man
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tk8.6.12-src.tar.gz
            sha256: 12395c1f3fcb6bed2938689f797ea3cdf41ed5cb6c4766eec8ac949560310630
            x-checker-data:
              type: anitya
              project-id: 11426
              stable-only: true
              url-template: https://prdownloads.sourceforge.net/tcl/tk$version-src.tar.gz

  # Python dependencies required to build things
  - name: python3-toml
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "toml" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz
        sha256: b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f
        x-checker-data:
          type: pypi
          name: toml
  # Bootstrap flit_core and tomli due to their circular dependence on each other.
  - name: python3-flit_core
    buildsystem: simple
    build-options:
      env:
        # Ensure the tomli source module can be used at runtime by flit_core to build tomli...
        PYTHONPATH: /run/build/python3-flit_core/tomli-src
    build-commands:
      # Build and install flit_core first, which doesn't require tomli.
      - python3 build_dists.py
      - unzip dist/flit_core-*-py3-none-any.whl -d ${FLATPAK_DEST}/lib/python3.9/site-packages
      # First, create the wheel metadata for tomli using flit_core.
      - mkdir tomli-src/tomli-metadata
      - cd tomli-src && python3 -c 'from flit_core.buildapi import prepare_metadata_for_build_wheel;
        prepare_metadata_for_build_wheel("tomli-metadata")'
      # Now create the wheel for tomli using flit_core.
      - mkdir tomli-src/tomli-wheel
      - cd tomli-src && python3 -c 'from flit_core.buildapi import build_wheel; build_wheel("tomli-wheel",
        metadata_directory="tomli-metadata")'
      # Finally, install the tomli wheel.
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}/tomli-src/tomli-wheel"
        --prefix=${FLATPAK_DEST} "tomli" --no-build-isolation
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/26/12/74c9b72b280006a97fb80268e6b84bf77c73837d93391c8238488c6f2dde/flit_core-3.5.0.tar.gz
        sha256: 2db800d33ff41e4c6e7c1b594666cb2a11553024106655272c7245933b1d75bd
        x-checker-data:
          type: pypi
          name: flit_core
      - type: archive
        url: https://files.pythonhosted.org/packages/aa/5b/62165da80cbc6e1779f342234c7ddc6c6bc9e64cef149046a9c0456f912b/tomli-1.2.2.tar.gz
        sha256: c6ce0015eb38820eaf32b5db832dbc26deb3dd427bd5f6556cf0acac2c214fee
        dest: tomli-src
        x-checker-data:
          type: pypi
          name: tomli
  - name: python3-poetry-core
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "poetry-core" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/40/d0/adc9ab25f68d9382f32c355627423a32135efaa5aaeebd6dec6d19e6b0af/poetry-core-1.0.7.tar.gz
        sha256: 98c11c755a16ef6c5673c22ca94a3802a7df4746a0853a70b6fae8b9f5cac206
        x-checker-data:
          type: pypi
          name: poetry-core
  - name: python3-setuptools_scm
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "setuptools_scm" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c1/47/dfc9c342c9842bbe0036c7f763d2d6686bcf5eb1808ba3e170afdb282210/pyparsing-2.4.7.tar.gz
        sha256: c203ec8783bf771a155b207279b9bccb8dea02d8f0c9e5f8ead507bc3246ecc1
        # The packaging dependency does not support pyparsing 3 yet, so don't update to 3.x.x.
        # x-checker-data:
        #   type: pypi
        #   name: pyparsing
      - type: file
        url: https://files.pythonhosted.org/packages/df/9e/d1a7217f69310c1db8fdf8ab396229f55a699ce34a203691794c5d1cad0c/packaging-21.3.tar.gz
        sha256: dd47c42927d89ab911e606518907cc2d3a1f38bbd026385970643f9c5b8ecfeb
        x-checker-data:
          type: pypi
          name: packaging
      - type: file
        url: https://files.pythonhosted.org/packages/4b/0d/ecb9595fae02467edba5023eb8a23c688d2b438a6a8d1a9e2b8649faf23d/setuptools_scm-6.3.2.tar.gz
        sha256: a49aa8081eeb3514eb9728fa5040f2eaa962d6c6f4ec9c32f6c1fba88f88a0f2
        x-checker-data:
          type: pypi
          name: setuptools_scm
  - name: python3-setuptools_rust
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "setuptools_rust" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/17/61/32c3ab8951142e061587d957226b5683d1387fb22d95b4f69186d92616d1/typing_extensions-4.0.0-py3-none-any.whl
        sha256: 829704698b22e13ec9eaf959122315eabb370b0884400e9818334d8b677023d9
        x-checker-data:
          type: pypi
          name: typing_extensions
      - type: file
        url: https://files.pythonhosted.org/packages/a5/15/00ef3b7888a10363b7c402350eda3acf395ff05bebae312d1296e528516a/semantic_version-2.8.5-py2.py3-none-any.whl
        sha256: 45e4b32ee9d6d70ba5f440ec8cc5221074c7f4b0e8918bdab748cc37912440a9
        x-checker-data:
          type: pypi
          name: semantic_version
      - type: file
        url: https://files.pythonhosted.org/packages/22/fa/ac431f0571bd84d8da5b55d9c9a00d510ae8682324405eabd96a752d090c/setuptools-rust-1.0.0.tar.gz
        sha256: eb6e6d41f01e63d042288e5c609684adf93426c10ea745ec324263f3fcbf27e9
        x-checker-data:
          type: pypi
          name: setuptools-rust
  - name: pytest-runner
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://github.com/pytest-dev/pytest-runner.git
        tag: v5.3.1
        commit: 592d891f99371664387e319eb45c3d28ba485afc
        x-checker-data:
          type: json
          url: https://api.github.com/repos/pytest-dev/pytest-runner/releases/latest
          tag-query: .tag_name
          version-query: .tag_name | sub("^v"; "")
          timestamp-query: .published_at

  # The cryptography Python library is handled specially since it has Rust code and dependencies.
  - name: python3-cryptography
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/python3-cryptography/cargo
        CARGO_NET_OFFLINE: 'true'
        RUST_BACKTRACE: '1'
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "cryptography" --no-build-isolation --no-binary cryptography
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/5e/0b/95d387f5f4433cb0f53ff7ad859bd2c6051051cebbb564f139a999ab46de/pycparser-2.21.tar.gz
        sha256: e644fdec12f7872f86c58ff790da456218b10f863970249516d60a5eaca77206
        x-checker-data:
          type: pypi
          name: pycparser
      - type: file
        url: https://files.pythonhosted.org/packages/00/9e/92de7e1217ccc3d5f352ba21e52398372525765b2e0c4530e6eb2ba9282a/cffi-1.15.0.tar.gz
        sha256: 920f0d66a896c2d99f0adbb391f990a84091179542c205fa53ce5787aff87954
        x-checker-data:
          type: pypi
          name: cffi
      - type: file
        url: https://files.pythonhosted.org/packages/60/06/d9109aba62c0b42466195e5b9b30dded26621a675b73998218070d8cc637/cryptography-36.0.0.tar.gz
        sha256: 52f769ecb4ef39865719aedc67b4b7eae167bafa48dbc2a26dd36fa56460507f
        x-checker-data:
          type: pypi
          name: cryptography
      # The Cargo sources should be updated whenever cryptography is updated.
      - cargo-sources.json

  # Python dependencies
  - python3-modules.json

  - name: thonny
    buildsystem: simple
    ensure-writable:
      - /lib/python3.9/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST}
      - install -Dm644 packaging/linux/org.thonny.Thonny.desktop -t ${FLATPAK_DEST}/share/applications
      - sed -i 's/Icon=thonny/Icon=org.thonny.Thonny/' ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - sed -i 's|Exec=/usr/bin/thonny|Exec=thonny|g' ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - for size in 16x16 22x22 32x32 48x48 64x64 128x128 192x192 256x256; do install
        -Dm644 -T packaging/icons/thonny-$size.png ${FLATPAK_DEST}/share/icons/hicolor/$size/apps/${FLATPAK_ID}.png;
        done
      - install -Dm644 packaging/linux/org.thonny.Thonny.appdata.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml
    sources:
      - thonny-sources.yaml
