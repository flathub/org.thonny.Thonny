id: org.thonny.Thonny
runtime: org.freedesktop.Sdk
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: thonny
cleanup:
  - /man
  - /share/man
finish-args:
  # Thonny requires access to serial / USB devices for embedded development.
  - --device=all

  - --share=ipc
  - --share=network
  - --socket=x11
modules:
  # The `tkinter` module is missing from the Freedesktop Sdk's Python installation.
  - name: tkinter
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} .
    sources:
      - type: git
        url: https://github.com/iwalton3/tkinter-standalone
        commit: ba946536054f9d27a08aafde21aa18330ce05729
    modules:
      - name: tcl
        buildsystem: autotools
        subdir: unix
        post-install:
          - chmod 755 /app/lib/libtcl*.so
        cleanup:
          - /bin
          - /lib/pkgconfig
          - /man
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tcl8.6.11-src.tar.gz
            sha256: 8c0486668586672c5693d7d95817cb05a18c5ecca2f40e2836b9578064088258
            x-checker-data:
              type: anitya
              project-id: 4941
              stable-only: true
              url-template: https://prdownloads.sourceforge.net/tcl/tcl$version-src.tar.gz
      - name: tk
        buildsystem: autotools
        subdir: unix
        post-install:
          - chmod 755 /app/lib/libtk*.so
        cleanup:
          - /bin
          - /lib/pkgconfig
          - /man
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tk8.6.11.1-src.tar.gz
            sha256: 006cab171beeca6a968b6d617588538176f27be232a2b334a0e96173e89909be
            x-checker-data:
              type: anitya
              project-id: 11426
              stable-only: true
              url-template: https://prdownloads.sourceforge.net/tcl/tk$version-src.tar.gz

  # Python dependencies required to build things
  - name: python3-toml
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "toml" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz
        sha256: b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f
        x-checker-data:
          type: pypi
          name: toml
  # Bootstrap flit_core and tomli due to their circular dependence on each other.
  - name: python3-flit_core
    buildsystem: simple
    build-options:
      env:
        # Ensure the tomli source module can be used at runtime by flit_core to build tomli...
        PYTHONPATH: /run/build/python3-flit_core/tomli-src
    build-commands:
      # Build and install flit_core first, which doesn't require tomli.
      - python3 build_dists.py
      - unzip dist/flit_core-*-py3-none-any.whl -d ${FLATPAK_DEST}/lib/python3.9/site-packages
      # First, create the wheel metadata for tomli using flit_core.
      - mkdir tomli-src/tomli-metadata
      - cd tomli-src && python3 -c 'from flit_core.buildapi import prepare_metadata_for_build_wheel;
        prepare_metadata_for_build_wheel("tomli-metadata")'
      # Now create the wheel for tomli using flit_core.
      - mkdir tomli-src/tomli-wheel
      - cd tomli-src && python3 -c 'from flit_core.buildapi import build_wheel; build_wheel("tomli-wheel",
        metadata_directory="tomli-metadata")'
      # Finally, install the tomli wheel.
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}/tomli-src/tomli-wheel"
        --prefix=${FLATPAK_DEST} "tomli" --no-build-isolation
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/2c/a9/64406cf5c1c31186e1208a290ff10a0add43882edaef5eeba49e15ba6e7f/flit_core-3.4.0.tar.gz
        sha256: 29468fa2330969167d1f5c23eb9c0661cb6dacfcd46f361a274609a7f4197530
        x-checker-data:
          type: pypi
          name: flit_core
      - type: archive
        url: https://files.pythonhosted.org/packages/aa/5b/62165da80cbc6e1779f342234c7ddc6c6bc9e64cef149046a9c0456f912b/tomli-1.2.2.tar.gz
        sha256: c6ce0015eb38820eaf32b5db832dbc26deb3dd427bd5f6556cf0acac2c214fee
        dest: tomli-src
        x-checker-data:
          type: pypi
          name: tomli
  - name: python3-poetry-core
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "poetry-core" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/40/d0/adc9ab25f68d9382f32c355627423a32135efaa5aaeebd6dec6d19e6b0af/poetry-core-1.0.7.tar.gz
        sha256: 98c11c755a16ef6c5673c22ca94a3802a7df4746a0853a70b6fae8b9f5cac206
        x-checker-data:
          type: pypi
          name: poetry-core
  - name: python3-setuptools_scm
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "setuptools_scm" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/a0/e4/2bae99e2bbdeb17c7cb9c2f7ef6022383ffcab8461d2ec339ff19ce4a969/pyparsing-3.0.3.tar.gz
        sha256: 9e3511118010f112a4b4b435ae50e1eaa610cda191acb9e421d60cf5fde83455
        x-checker-data:
          type: pypi
          name: pyparsing
      - type: file
        url: https://files.pythonhosted.org/packages/df/86/aef78bab3afd461faecf9955a6501c4999933a48394e90f03cd512aad844/packaging-21.0.tar.gz
        sha256: 7dc96269f53a4ccec5c0670940a4281106dd0bb343f47b7471f779df49c2fbe7
        x-checker-data:
          type: pypi
          name: packaging
      - type: file
        url: https://files.pythonhosted.org/packages/4b/0d/ecb9595fae02467edba5023eb8a23c688d2b438a6a8d1a9e2b8649faf23d/setuptools_scm-6.3.2.tar.gz
        sha256: a49aa8081eeb3514eb9728fa5040f2eaa962d6c6f4ec9c32f6c1fba88f88a0f2
        x-checker-data:
          type: pypi
          name: setuptools_scm
  - name: python3-setuptools_rust
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "setuptools_rust" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/d4/52/3be868c7ed1f408cb822bc92ce17ffe4e97d11c42caafce0589f05844dd0/semantic_version-2.8.5.tar.gz
        sha256: d2cb2de0558762934679b9a104e82eca7af448c9f4974d1f3eeccff651df8a54
        x-checker-data:
          type: pypi
          name: semantic_version
      - type: file
        url: https://files.pythonhosted.org/packages/12/22/6ba3031e7cbd6eb002e13ffc7397e136df95813b6a2bd71ece52a8f89613/setuptools-rust-0.12.1.tar.gz
        sha256: 647009e924f0ae439c7f3e0141a184a69ad247ecb9044c511dabde232d3d570e
        x-checker-data:
          type: pypi
          name: setuptools-rust
  - name: pytest-runner
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://github.com/pytest-dev/pytest-runner.git
        tag: v5.3.1
        commit: 592d891f99371664387e319eb45c3d28ba485afc
        x-checker-data:
          type: json
          url: https://api.github.com/repos/pytest-dev/pytest-runner/releases/latest
          tag-query: .tag_name
          version-query: .tag_name | sub("^v"; "")
          timestamp-query: .published_at

  # The cryptography Python library is handled specially since it has Rust code and dependencies.
  - name: python3-cryptography
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/python3-cryptography/cargo
        CARGO_NET_OFFLINE: 'true'
        RUST_BACKTRACE: '1'
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "cryptography" --no-build-isolation --no-binary cryptography
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/0f/86/e19659527668d70be91d0369aeaa055b4eb396b0f387a4f92293a20035bd/pycparser-2.20.tar.gz
        sha256: 2d475327684562c3a96cc71adf7dc8c4f0565175cf86b6d7a404ff4c771f15f0
        x-checker-data:
          type: pypi
          name: pycparser
      - type: file
        url: https://files.pythonhosted.org/packages/00/9e/92de7e1217ccc3d5f352ba21e52398372525765b2e0c4530e6eb2ba9282a/cffi-1.15.0.tar.gz
        sha256: 920f0d66a896c2d99f0adbb391f990a84091179542c205fa53ce5787aff87954
        x-checker-data:
          type: pypi
          name: cffi
      - type: file
        url: https://files.pythonhosted.org/packages/10/91/90b8d4cd611ac2aa526290ae4b4285aa5ea57ee191c63c2f3d04170d7683/cryptography-35.0.0.tar.gz
        sha256: 9933f28f70d0517686bd7de36166dda42094eac49415459d9bdf5e7df3e0086d
        x-checker-data:
          type: pypi
          name: cryptography
      # The Cargo sources should be updated whenever cryptography is updated.
      - cargo-sources.json

  # Python dependencies
  - python3-modules.json

  - name: thonny
    buildsystem: simple
    ensure-writable:
      - /lib/python3.9/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST}
      - install -Dm644 packaging/linux/org.thonny.Thonny.desktop -t ${FLATPAK_DEST}/share/applications
      - sed -i 's/Icon=thonny/Icon=org.thonny.Thonny/' ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - sed -i 's|Exec=/usr/bin/thonny|Exec=thonny|g' ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - for size in 16x16 22x22 32x32 48x48 64x64 128x128 192x192 256x256; do install
        -Dm644 -T packaging/icons/thonny-$size.png ${FLATPAK_DEST}/share/icons/hicolor/$size/apps/${FLATPAK_ID}.png;
        done
      - install -Dm644 packaging/linux/org.thonny.Thonny.appdata.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml
    sources:
      - thonny-sources.yaml
