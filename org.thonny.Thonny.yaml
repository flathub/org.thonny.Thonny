id: org.thonny.Thonny
runtime: org.freedesktop.Sdk
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: thonny.sh
cleanup:
  - /man
  - /share/man
finish-args:
  # Thonny requires access to serial / USB devices for embedded development.
  - --device=all

  - --filesystem=/media
  - --filesystem=/run/media

  # todo Remove filesystem=home permissions when it's possible to open directories with the native file chooser dialog.
  - --filesystem=home

  - --share=ipc
  - --share=network
  - --socket=x11
  - --system-talk-name=org.freedesktop.UDisks2
modules:
  # The `tkinter` module is missing from the Freedesktop Sdk's Python installation.
  - name: tkinter
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} .
    sources:
      - type: git
        url: https://github.com/iwalton3/tkinter-standalone
        commit: 4f5cfe3cdd1f58cd4e136fd66d4e5e27d21d820b
    modules:
      - name: tcl
        buildsystem: autotools
        subdir: unix
        post-install:
          - chmod +w ${FLATPAK_DEST}/lib/libtcl*.so
        build-options: &tcl-build-options
          # Workaround UTF-8 encoding issue in Tcl < 9
          cflags: -DTCL_UTF_MAX=4
        cleanup:
          - /bin
          - /lib/pkgconfig
          - /man
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tcl8.6.15-src.tar.gz
            sha256: 861e159753f2e2fbd6ec1484103715b0be56be3357522b858d3cbb5f893ffef1
            # todo Can't update to Tcl/Tk 9 until Python is updated.
            # Refer to this issue: https://github.com/python/cpython/issues/124111
            # x-checker-data:
            #   type: anitya
            #   project-id: 4941
            #   stable-only: true
            #   url-template: https://prdownloads.sourceforge.net/tcl/tcl$version-src.tar.gz
      - name: tk
        buildsystem: autotools
        subdir: unix
        post-install:
          # libtcl*tk*.so in Tk 9
          - chmod +w ${FLATPAK_DEST}/lib/libtk*.so
        build-options: *tcl-build-options
        cleanup:
          - /bin
          - /lib/pkgconfig
          - /man
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tk8.6.15-src.tar.gz
            sha256: 550969f35379f952b3020f3ab7b9dd5bfd11c1ef7c9b7c6a75f5c49aca793fec
            # todo Can't update to Tcl/Tk 9 until Python is updated.
            # Refer to this issue: https://github.com/python/cpython/issues/124111
            # x-checker-data:
            #   type: anitya
            #   project-id: 11426
            #   stable-only: true
            #   url-template: https://prdownloads.sourceforge.net/tcl/tk$version-src.tar.gz
      # - name: libtommath
      #   buildsystem: cmake-ninja
      #   cleanup:
      #     - /bin
      #     - /lib/cmake
      #   sources:
      #     - type: archive
      #       url: https://github.com/libtom/libtommath/releases/download/v1.3.0/ltm-1.3.0.tar.xz
      #       sha256: 296272d93435991308eb73607600c034b558807a07e829e751142e65ccfa9d08
      #       x-checker-data:
      #         type: anitya
      #         project-id: 15565
      #         stable-only: true
      #         url-template: https://github.com/libtom/libtommath/releases/download/v$version/ltm-$version.tar.xz

  # Add back the Turtle Python module which is stripped out of the org.freedesktop.Sdk.
  # Be sure to use the turtle module from the same version of Python that's in the org.freedesktop.Sdk.
  # Update when updating runtime-version.
  - name: python3-turtle
    buildsystem: simple
    build-commands:
      - install -Dm644 turtle.py ${FLATPAK_DEST}/lib/python3.11/site-packages/turtle.py
    sources:
      - type: file
        url: https://raw.githubusercontent.com/python/cpython/v3.11.6/Lib/turtle.py
        sha256: 787af385d6d4417aac8b686e8d5f49ce4afd7d1d09bde685bb378ed6ecc4fb7d

  # Python dependencies required to build things
  - name: python3-toml
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "toml" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz
        sha256: b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f
        x-checker-data:
          type: pypi
          name: toml
  - name: python3-flit_core
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "flit_core" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/d5/ae/09427bea9227a33ec834ed5461432752fd5d02b14f93dd68406c91684622/flit_core-3.10.1.tar.gz
        sha256: 66e5b87874a0d6e39691f0e22f09306736b633548670ad3c09ec9db03c5662f7
        x-checker-data:
          type: pypi
          name: flit_core
  - name: python3-poetry-core
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "poetry-core" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c4/f5/89d11008714e0a49cab9cba7cce89c66ea5a94f37cc6d283798cc1725fac/poetry_core-2.0.1.tar.gz
        sha256: 10177c2772469d9032a49f0d8707af761b1c597cea3b4fb31546e5cd436eb157
        x-checker-data:
          type: pypi
          name: poetry-core
  - name: python3-setuptools_scm
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "setuptools_scm" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/1c/a7/c8a2d361bf89c0d9577c934ebb7421b25dc84bf3a8e3ac0a40aed9acc547/pyparsing-3.2.1-py3-none-any.whl
        sha256: 506ff4f4386c4cec0590ec19e6302d3aedb992fdc02c761e90416f158dacf8e1
        x-checker-data:
          name: pyparsing
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/26/9f/ad63fc0248c5379346306f8668cda6e2e2e9c95e01216d2b8ffd9ff037d0/typing_extensions-4.12.2-py3-none-any.whl
        sha256: 04e5ca0351e0f3f85c6853954072df659d0d13fac324d0072316b67d7794700d
        x-checker-data:
          name: typing_extensions
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/6e/c2/61d3e0f47e2b74ef40a68b9e6ad5984f6241a942f7cd3bbfbdbd03861ea9/tomli-2.2.1-py3-none-any.whl
        sha256: cb55c73c5f4408779d0cf3eef9f762b9c9f147a77de7b258bef0a5628adc85cc
        x-checker-data:
          name: tomli
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/88/ef/eb23f262cca3c0c4eb7ab1933c3b1f03d021f2c48f54763065b6f0e321be/packaging-24.2-py3-none-any.whl
        sha256: 09abb1bccd265c01f4a3aa3f7a7db064b36514d2cba19a2f694fe6150451a759
        x-checker-data:
          name: packaging
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/a0/b9/1906bfeb30f2fc13bb39bf7ddb8749784c05faadbd18a21cf141ba37bff2/setuptools_scm-8.1.0-py3-none-any.whl
        sha256: 897a3226a6fd4a6eb2f068745e49733261a21f70b1bb28fce0339feb978d9af3
        x-checker-data:
          name: setuptools_scm
          packagetype: bdist_wheel
          type: pypi
  - name: python3-typing_extensions
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "typing_extensions" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/26/9f/ad63fc0248c5379346306f8668cda6e2e2e9c95e01216d2b8ffd9ff037d0/typing_extensions-4.12.2-py3-none-any.whl
        sha256: 04e5ca0351e0f3f85c6853954072df659d0d13fac324d0072316b67d7794700d
        x-checker-data:
          type: pypi
          name: typing_extensions
          packagetype: bdist_wheel
  - name: python3-setuptools_rust
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "setuptools_rust" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/7d/31/f2289ce78b9b473d582568c234e104d2a342fd658cc288a7553d83bb8595/semantic_version-2.10.0.tar.gz
        sha256: bdabb6d336998cbb378d4b9db3a4b56a1e3235701dc05ea2690d9a997ed5041c
        x-checker-data:
          type: pypi
          name: semantic_version
      - type: file
        url: https://files.pythonhosted.org/packages/d3/6b/99a1588d826ceb108694ba00f78bc6afda10ed5d72d550ae8f256af1f7b4/setuptools_rust-1.10.2.tar.gz
        sha256: 5d73e7eee5f87a6417285b617c97088a7c20d1a70fcea60e3bdc94ff567c29dc
        x-checker-data:
          type: pypi
          name: setuptools-rust

  # The cryptography Python library is handled specially since it has Rust code and dependencies.
  - name: python3-cryptography
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/python3-cryptography/cargo
        CARGO_NET_OFFLINE: 'true'
        RUST_BACKTRACE: '1'
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "cryptography" --no-build-isolation --no-binary cryptography
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/1d/b2/31537cf4b1ca988837256c910a668b553fceb8f069bedc4b1c826024b52c/pycparser-2.22.tar.gz
        sha256: 491c8be9c040f5390f5bf44a5b07752bd07f56edf992381b05c701439eec10f6
        x-checker-data:
          type: pypi
          name: pycparser
      - type: file
        url: https://files.pythonhosted.org/packages/fc/97/c783634659c2920c3fc70419e3af40972dbaf758daa229a7d6ea6135c90d/cffi-1.17.1.tar.gz
        sha256: 1c39c6016c32bc48dd54561950ebd6836e1670f2ae46128f67cf49e789c52824
        x-checker-data:
          type: pypi
          name: cffi
      - type: file
        url: https://files.pythonhosted.org/packages/e3/3f/41186b1f2fd86a542d399175f6b8e43f82cd4dfa51235a0b030a042b811a/cryptography-38.0.4.tar.gz
        sha256: 175c1a818b87c9ac80bb7377f5520b7f31b3ef2a0004e2420319beadedb67290
      # The Cargo sources should be updated whenever cryptography is updated.
      - cryptography-cargo-sources.json

  # The bcrypt Python library is handled specially since it has Rust code and dependencies.
  # The cryptography Python library is handled specially since it has Rust code and dependencies.
  - name: python3-bcrypt
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/python3-bcrypt/cargo
        CARGO_NET_OFFLINE: 'true'
        RUST_BACKTRACE: '1'
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "bcrypt" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/8c/ae/3af7d006aacf513975fd1948a6b4d6f8b4a307f8a244e1a3d3774b297aad/bcrypt-4.0.1.tar.gz
        sha256: 27d375903ac8261cfe4047f6709d16f7d18d39b1ec92aaf72af989552a650ebd
      # The Cargo sources should be updated whenever bcrypt is updated.
      - bcrypt-cargo-sources.json

  # Python dependencies
  - bundled-python-modules.json

  - name: thonny
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/
      - install -Dm644 packaging/linux/org.thonny.Thonny.desktop -t ${FLATPAK_DEST}/share/applications
      - sed -i 's/Icon=thonny/Icon=org.thonny.Thonny/' ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - sed -i 's|Exec=/usr/bin/thonny|Exec=thonny|g' ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - for size in 16x16 22x22 32x32 48x48 64x64 128x128 192x192 256x256; do install
        -Dm644 -T packaging/icons/thonny-$size.png ${FLATPAK_DEST}/share/icons/hicolor/$size/apps/${FLATPAK_ID}.png;
        done
      - install -Dm644 packaging/linux/org.thonny.Thonny.appdata.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml
      - install -Dm 755 -t /app/bin/ thonny.sh
    sources:
      - thonny-sources.yaml
      - type: patch
        path: 0001-Update-appstream-metadata-3098.patch
      - type: patch
        path: 0002-Create-venv-and-install-pip-in-venv-as-separate-step.patch
      - type: script
        dest-filename: thonny.sh
        commands:
          # Set PYTHONUSERBASE to be under the ~/.var/app/org.thonny.Thonny/data directory.
          - export PYTHONUSERBASE=$XDG_DATA_HOME
          - /app/bin/thonny "$@"
